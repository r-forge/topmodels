---
title: "Graphical Model Assessment"
author: "Moritz Lang, Achim Zeileis"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
bibliography: ref.bib
vignette: >
  %\VignetteIndexEntry{Graphical Model Assessment under Different Model Misspecifications}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteDepends{topmodels,crch,MASS,rmutil,sn}
  %\VignetteKeywords{FIXME}
  %\VignettePackage{topmodels}
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{r preliminaries, echo = FALSE, message = FALSE}
library("topmodels")
library("crch")
library("MASS")
library("rmutil")  # for laplace dist
library("sn") # for skewed N dist
options(digits = 4)
knitr::opts_chunk$set(fig.aling = "center")

## helper function for plotting residuals
make_residuals_plot <- function(object, xlim = c(-4, 4), ylim = c(0, 0.5)) {

  ## histogram
  hist(qresiduals(object), breaks = 15, main = "", freq = FALSE, xlim = xlim, ylim = ylim)

  ## standard normal distribution
  curve(dnorm, col = 2, from = -4, to = 4, add = TRUE)

  ## legend
  legend("topright", "std. norm", lty = 1, col = 2, bty = "n")
}

make_topmodels_plot <- function(object) {
  topmodels(object, which = c(1:2, 4:5), ask = FALSE, spar = FALSE)
}
```

## Artifical data

```{r dgp}
set.seed(0)

## regressors
d <- data.frame( 
  x = runif(500, -1, 1),
  z = runif(500, -1, 1)
)

## parameters
d <- transform(d,
  lambda = exp(1 + 0.5 * x),
  theta = 2,
  mu = 50 + 22 * x,
  sigma = 22,
  sigmaz = exp(3 + 1 * z)
)

## responses
d <- transform(d,
  ynorm = rnorm(500, mean = mu, sd = sigma),

  yhnorm = rnorm(500, mean = mu, sd = sigmaz),
  ytnorm = crch::rtnorm(500, mean = mu, sd = sigma, left = 0),
  ycnorm = crch::rcnorm(500, mean = mu, sd = sigma, left = 0, right = 100),

  yt = mu + sigma * rt(500, df = 4),
  ylaplace = mu + rmutil::rlaplace(500, s = sigma),
  yrskew = sn::rsn(500, xi = mu, omega = sigma, alpha = 5, tau = 0),
  ylskew = sn::rsn(500, xi = mu, omega = sigma, alpha = -5, tau = 0),
  yunif = mu + sigma * runif(500, min = -1, max = 1),

  ypois = rpois(500, lambda = lambda),
  ynegbin = rnbinom(500, mu = lambda, size = theta),
  yzip = ifelse(runif(500) < 0.25, 0, rpois(500, lambda = lambda))
)
```

## Continuous data 

### Homoscedastic normal

```{r fit-1}
## correct model fit
m1 <- lm(ynorm ~ x, data = d)
```

```{r topmodels-1, echo = FALSE, fig.height = 2.5, out.width = "100%", fig.align = "center"}
par(mfrow = c(1, 4), bg = "#f7f7f7")
make_topmodels_plot(m1)
par(mfrow = c(1, 1))
```

### Conditional heteroscedasticity

```{r fit-2}
## not accounting for heteroscedasticity
m2 <- lm(yhnorm ~ x, data = d)

### accounting for heteroscedasticity
m3 <- crch(yhnorm ~ x | z, data = d)
```

```{r qresiduals-2, echo = FALSE, fig.height = 3, out.width = "50%", fig.align = "center"}
par(mfrow = c(1, 2), bg = "#f7f7f7")
make_residuals_plot(m2)
make_residuals_plot(m3)
par(mfrow = c(1, 1))
```

```{r topmodels-2, echo = FALSE, fig.height = 4.5, out.width = "100%", fig.align = "center"}
par(mfrow = c(2, 4), bg = "#f7f7f7")
make_topmodels_plot(m2)
make_topmodels_plot(m3)
```

### Censoring (0, 100)

```{r fit-3}
## not accounting for censoring
m4 <- lm(ycnorm ~ x, data = d)

## accounting for censoring
m5 <- crch(ycnorm ~ x | 1, data = d, left = 0, right = 100)
```

```{r qresiduals-3, echo = FALSE, fig.height = 3, out.width = "50%", fig.align = "center"}
par(mfrow = c(1, 2), bg = "#f7f7f7")
make_residuals_plot(m4)
make_residuals_plot(m5)
par(mfrow = c(1, 1))
```

```{r topmodels-3, echo = FALSE, fig.height = 4.5, out.width = "100%", fig.align = "center"}
par(mfrow = c(2, 4), bg = "#f7f7f7")
make_topmodels_plot(m4)
make_topmodels_plot(m5)
```

### Truncation (> 0)

```{r fit-4}
## not accounting for truncation
m6 <- lm(ytnorm ~ x, data = d)

# not accounting for truncation
m7 <- trch(ytnorm ~ x | 1, data = d, left = 0)
```

```{r qresiduals-4, echo = FALSE, fig.height = 3, out.width = "50%", fig.align = "center"}
par(mfrow = c(1, 2), bg = "#f7f7f7")
make_residuals_plot(m6)
make_residuals_plot(m7)
par(mfrow = c(1, 1))
```

```{r topmodels-4, echo = FALSE, fig.height = 4.5, out.width = "100%", fig.align = "center"}
par(mfrow = c(2, 4), bg = "#f7f7f7")
make_topmodels_plot(m6)
make_topmodels_plot(m7)
```

### Heavy tails (t_4)

```{r fit-5}
## not accounting for heavy tails
m8 <- lm(yt ~ x, data = d)

## accounting for heavy tails
m9 <- crch(yt ~ x | 1, data = d, dist = "student")
```

```{r qresiduals-5, echo = FALSE, fig.height = 3, out.width = "50%", fig.align = "center"}
par(mfrow = c(1, 2), bg = "#f7f7f7")
make_residuals_plot(m8)
make_residuals_plot(m9)
par(mfrow = c(1, 1))
```

```{r topmodels-5, echo = FALSE, fig.height = 4.5, out.width = "100%", fig.align = "center"}
par(mfrow = c(2, 4), bg = "#f7f7f7")
make_topmodels_plot(m8)
make_topmodels_plot(m9)
```

### Skewness
```{r fit-6}
## not accounting for right skewed residuals
m10 <- lm(yrskew ~ x, data = d)

## not accounting for left skewed residuals
m11 <- lm(ylskew ~ x, data = d)
```

```{r qresiduals-6, echo = FALSE, fig.height = 3, out.width = "50%", fig.align = "center"}
par(mfrow = c(1, 2), bg = "#f7f7f7")
make_residuals_plot(m10)
make_residuals_plot(m11)
par(mfrow = c(1, 1))
```

```{r topmodels-6, echo = FALSE, fig.height = 4.5, out.width = "100%", fig.align = "center"}
par(mfrow = c(2, 4), bg = "#f7f7f7")
make_topmodels_plot(m10)
make_topmodels_plot(m11)
```

### Over-/Underdispersion
Other misspecified distribution: uniform, laplace

```{r fit-7}
## misspecified distribution leading to an underdispersed predictive distribution
m12 <- lm(yunif ~ x, data = d)

## misspecified distribution leading to an overdispersed predictive distribution
m13 <- lm(ylaplace ~ x, data = d)
```

```{r qresiduals-7, echo = FALSE, fig.height = 3, out.width = "50%", fig.align = "center"}
par(mfrow = c(1, 2), bg = "#f7f7f7")
make_residuals_plot(m12)
make_residuals_plot(m13)
par(mfrow = c(1, 1))
```

```{r topmodels-7, echo = FALSE, fig.height = 4.5, out.width = "100%", fig.align = "center"}
par(mfrow = c(2, 4), bg = "#f7f7f7")
make_topmodels_plot(m12)
make_topmodels_plot(m13)
```

## Count data 

### Poisson
```{r fit-8}
## correct model fit
cm1 <- glm(ypois ~ x, data = d, family = poisson)
```

```{r topmodels-8, echo = FALSE, fig.height = 2.5, out.width = "100%", fig.align = "center"}
par(mfrow = c(1, 4), bg = "#f7f7f7")
make_topmodels_plot(cm1)
par(mfrow = c(1, 1))
```

### Overdispersion (negative binomial)
```{r fit-9}
## misspecified distribution leading to an overdispersed predictive distribution
cm2 <- glm(ynegbin ~ x, data = d, family = poisson)

## correct distributional assumption
cm3 <- MASS::glm.nb(ynegbin ~ x, data = d)
```

```{r qresiduals-9, echo = FALSE, fig.height = 3, out.width = "50%", fig.align = "center"}
par(mfrow = c(1, 2), bg = "#f7f7f7")
make_residuals_plot(cm2)
make_residuals_plot(cm3)
par(mfrow = c(1, 1))
```

```{r topmodels-9, echo = FALSE, fig.height = 4.5, out.width = "100%", fig.align = "center"}
par(mfrow = c(2, 4), bg = "#f7f7f7")
make_topmodels_plot(cm2)
make_topmodels_plot(cm3)
```

### Zero-inflation

```{r fit-10}
## not accouting for zero inflation
cm4 <- glm(yzip ~ x, data = d, family = poisson)

## accouting for zero inflation
cm5 <- pscl::zeroinfl(yzip ~ x | 1, data = d, dist = "poisson")
```

```{r qresiduals-10, echo = FALSE, fig.height = 3, out.width = "50%", fig.align = "center"}
par(mfrow = c(1, 2), bg = "#f7f7f7")
make_residuals_plot(cm4)
#make_residuals_plot(cm5)
par(mfrow = c(1, 1))
```

```{r topmodels-10, echo = FALSE, fig.height = 4.5, out.width = "100%", fig.align = "center"}
par(mfrow = c(2, 4), bg = "#f7f7f7")
make_topmodels_plot(cm4)
#make_topmodels_plot(cm5)
```

## Summary



## References


