---
title: "Graphical Evaluation: Methodology"
author: "Moritz Lang, Achim Zeileis"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
bibliography: ref.bib
vignette: >
  %\VignetteIndexEntry{Graphical Model Assessment under Different Model Misspecifications}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteDepends{topmodels,crch,MASS,rmutil,sn}
  %\VignetteKeywords{FIXME}
  %\VignettePackage{topmodels}
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{r preliminaries, echo = FALSE, message = FALSE}
library("topmodels")
library("crch")
library("MASS")
library("rmutil")  # for laplace dist
library("sn") # for skewed N dist
options(digits = 4)
knitr::opts_chunk$set(fig.aling = "center")

make_residuals_plot <- function(object, breaks = "Sturges", main = "") {
  name <- deparse(substitute(object))

  set.seed(1)
  hist(qresiduals(object), breaks = breaks, freq = FALSE,
    main = main,
    xlab = "Q-Q residuals", xlim = c(-5, 5), ylim = c(0, 1)
  )
  curve(dnorm, from = -5, to = 5, col = 2, lwd = 2, add = TRUE)
  legend("topright", "std. norm", lty = 1, col = 2, lwd = 2, bty = "n")
  box()
}
```

```{r dgp, echo = FALSE}
set.seed(0)

## regressors
d <- data.frame(
  x = runif(500, -1, 1),
  z = runif(500, -1, 1)
)

d <- transform(d,
  y_norm = rnorm(500),
  y_rskew = sn::rsn(500, xi = 0, omega = 1, alpha = 5, tau = 0),
  y_lskew = sn::rsn(500, xi = 0, omega = 1, alpha = -5, tau = 0),

  y_htail = rt(500, df = 4),
  y_ltail = c(rnorm(100), runif(400, min = -1.5, max = 1.5)),

  y_odisp = rpois(500, lambda = exp(0 + 2 * x + rnorm(500, mean = 0, sd = 1.5))),
  y_udisp = round(rnorm(n = 500, mean = exp(0 + 2 * x), sd = 0.001))

)
```

```{r fit, echo = FALSE}
m_norm <- lm(y_norm ~ 1, data = d)
m_rskew <- lm(y_rskew ~ 1, data = d)
m_lskew <- lm(y_lskew ~ 1, data = d)
m_htail <- lm(y_htail ~ 1, data = d)
m_ltail <- lm(y_ltail ~ 1, data = d)

m_odisp <- glm(y_odisp ~ x, family = "poisson", data = d)
m_udisp <- glm(y_udisp ~ x, family = "poisson", data = d)
```

## Rootogram

The rootogram is a graphical tool for assessing the goodness of fit of a
parametric univariate distributional model $\mathcal{D}( \cdot )$, with
estimated parameters $\hat{\boldsymbol{\theta}}_{i} = (\hat{\theta}_{i1},
\ldots, \hat{\theta}_{iK})^\top$ and $\mathcal{D}( \cdot )$ desribing the
density or probability mass function. In the form presented, it was first
introduced by @Kleiber+Zeileis:2016 building on work of @Tukey:1977. 

Given an observational vector of a discrete random variable $y_i$, rootograms
check whether observed frequencies $\text{obs}_j$ match the expected
frequencies $\text{exp}_j$; hence, the observed and expected frequency are
given for for each integer $j$ by

$$\text{obs}_j = \sum_{i=1}^{n}I(y_i - j),$$
$$\text{exp}_j = \sum_{i=1}^{n}\mathcal{D}(j | \hat{\boldsymbol{\theta}}_{i}),$$

with the indicator variable $I( \cdot )$.

More generally or for a continuous random variable $y_i$, one can use a set of
breaks $b_0, b_1, b_2, \dots~$ that span a suitable subset of $y_i$. Here, the
observed and expected frequencies are given by

$$\text{obs}_j = \sum_{i=1}^{n}w_{i} I(y_i \in (b_j, b_{j+1}]),$$
$$\text{exp}_j = \sum_{i=1}^{n}w\{\mathbf{\mathcal{F}}(b_{j+1} | 
  \hat{\boldsymbol{\theta}}_{i}) - \mathbf{\mathcal{F}}(b_{j} | \hat{\boldsymbol{\theta}}_{i})\},$$

with $\mathbf{\mathcal{F}}( \cdot )$ being the CDF of the modeled
distributional model $\mathcal{D}( \cdot )$ and $w_i (i= 1, \dots, n)$ being
additional introduced observation-specific weights.  The weights are typically
needed either for survey data or for situations with model-based weights
[@Kleiber+Zeileis:2016].

## PIT Histogram

To check the calibration of a regression model, @Dawid:1984 proposed the use of
the probability integral transform (PIT) which is simply the predictive
cumulative distribution function (CDF) evaluated at the observations. For a
continuous random variable $y_i$, it is defined as 

$$u_i = \mathbf{\mathcal{F}}(y_i | \, \hat{\boldsymbol{\theta}}_i)$$

 where
$\mathbf{\mathcal{F}}( \cdot )$ denotes the CDF of the modeled distribution
$\mathcal{D}( \cdot )$ with estimated parameters $\hat{\boldsymbol{\theta}}_{i}
= (\hat{\theta}_{i1}, \ldots, \hat{\theta}_{iK})^\top$. If the estimated model
is a good approximation to the true data generating process, the observation
will be drawn from the predictive distribution and the PIT values $u_i$ are
approximately uniformly distributed on $[0, 1]$. Plotting the histogram of the
PIT values and checking for uniformity is therefore a common empirical way of
checking for calibration [@Diebold+Gunther+Tay:1998;
@Gneiting+Balabdaoui+Raftery:2007].  Whereas, deviations from uniformity point
to underlying forecast errors and model deficiencies: U-shaped histograms refer
to underdispersed predictive distributions, inverted U-shaped histograms to
overdispersion, and skewed histograms suggest that central tendencies must be
biased [@Czado+Gneiting+Held:2009].

When considering discrete response distributions or distributions with a
discrete component, e.g., in case of censoring, for a random discrete variable
$y_i$ the PIT $u_i$ is generated as a random draw from the interval
$\mathbf{\mathcal{F}}(y_i | \, \hat{\boldsymbol{\theta}}_i)$. Even if this
leads to some randomness in the graphical representation of PIT values, in most
cases the impact on the graphical evaluation when repeating the calculations
(i.e. drawing new values $u_i$) is rather small. (FIXME: Compare with
@Czado+Gneiting+Held:2009 and their references to random PITs).


## Q-Q Residuals Plot

Quantile residuals are simply the inverse cumulative distribution function of a
standard normal distribution $\Phi^{-1}$ evaluated at values PIT values $u_i$,
hence, they can be defined as 

$$\hat{r}_i = \Phi^{-1}(\mathbf{\mathcal{F}}(y_i | \, \hat{\boldsymbol{\theta}}_{i})) = 
  \Phi^{-1}(u_i),$$ 

where $\mathbf{\mathcal{F}}( \cdot )$ again denotes the cumulative distribution
function (CDF) of the modeled distribution $\mathcal{D}( \cdot )$ with
estimated parameters $\hat{\boldsymbol{\theta}}_{i} = (\hat{\theta}_{i1},
\ldots, \hat{\theta}_{iK})^\top$ [@Dunn+Smyth:1996]. As before, for discrete
or partly discrete responses, the approach includes some randomization to
achieve continuous $u_i$ values; quantile residuals are therefore often
referred to as randomized quantile residuals in the literature
[@Dunn+Smyth:1996]. 

In case of a correct model fit, the values $u_i$ are uniformly distributed on
the unit interval and the Q-Q residuals should at least approximately be
standard normally distributed. Hence, to check for normality, quantile
residuals can be graphically compared to theoretical quantiles of the standard
normal distribution, where strong deviations from the bisecting line indicate a
misspecified model fit. This graphical evaluation is well known as normal
probability plot or normal Q-Q plot [@Hoaglin:2006]. Due to the transformation
of the PIT values $u_i$ to the normal scale, their extreme values are more
widely spread, so that normal Q-Q diagrams are better suited than, for example,
PIT histograms to detect violations of the distribution assumption D within its
tails. An additional possible advantage of Q-Q plots is that they avoid the
necessity of defining breakpoints as typically needed for histogram style
evaluations [@Klein+Kneib+Lang+Sohn:2015].

But Q-Q plots can also be applied to check if residuals follow any other known
distribution, by employing any other inverse cumulative distribution function
of interest instead of $\Phi^{-1}$ in the computation and comparing the
quantile residuals $\hat{r}_i$ to the respective theoretical quantiles. This is
called than a theoretical quantile-quantile plot or Q-Q plot for short
[@Friendly:1991].


## Worm plot

As in Q-Q plots, small too medium deviations can be quite hard to detect,
untilting the plot by subtracting the theoretical quantiles, makes detecting
pattern of departure from a now horizontal line much easier. This so-called
de-trended Q-Q plot [@Friendly:1991] is best known by the application of
@Buuren+Fredriks:2001, and is therefore usually referred to as worm plot
according to their naming.

## Summary plot
```{r plot-qq, echo = FALSE, results = "hide"}
grDevices::svg(file = "figures/graph_eval_meth_qq.svg", width = 14, height = 14)
par(mfrow = c(6, 7), bg = "#f7f7f7")
make_residuals_plot(m_norm, breaks = 20, main = "Well calibrated")
make_residuals_plot(m_rskew, breaks = 20, main = "Too skew to the left")
make_residuals_plot(m_lskew, breaks = 20, main = "Too skew to the right")
make_residuals_plot(m_htail, breaks = 20, main = "Tails too light")
make_residuals_plot(m_ltail, breaks = 20, main = "Tails too heavy")
make_residuals_plot(m_odisp, main = "Underdispersed")
make_residuals_plot(m_udisp, main = "Overdispersed")
qqrplot(m_norm, main = "Q-Q residuals plot")
qqrplot(m_rskew, main = "Q-Q resiudals plot")
qqrplot(m_lskew, main = "Q-Q resiudals plot")
qqrplot(m_htail, main = "Q-Q resiudals plot")
qqrplot(m_ltail, main = "Q-Q resiudals plot")
qqrplot(m_odisp, main = "Q-Q resiudals plot")
qqrplot(m_udisp, main = "Q-Q resiudals plot")
#qqrplot(m_norm, trafo = identity, main = "Uniform Q-Q residuals plot")
#qqrplot(m_rskew, trafo = identity, main = "Uniform Q-Q resiudals plot")
#qqrplot(m_lskew, trafo = identity, main = "Uniform Q-Q resiudals plot")
#qqrplot(m_htail, trafo = identity, main = "Uniform Q-Q resiudals plot")
#qqrplot(m_ltail, trafo = identity, main = "Uniform Q-Q resiudals plot")
#qqrplot(m_odisp, trafo = identity, main = "Uniform Q-Q resiudals plot")
#qqrplot(m_udisp, trafo = identity, main = "Uniform Q-Q resiudals plot")
wormplot(m_norm, main = "Worm plot")
wormplot(m_rskew, main = "Worm plot")
wormplot(m_lskew, main = "Worm plot")
wormplot(m_htail, main = "Worm plot")
wormplot(m_ltail, main = "Worm plot")
wormplot(m_odisp, main = "Worm plot")
wormplot(m_udisp, main = "Worm plot")
pithist(m_norm, main = "PIT histogram")
pithist(m_rskew, main = "PIT histogram")
pithist(m_lskew, main = "PIT histogram")
pithist(m_htail, main = "PIT histogram") 
pithist(m_ltail, main = "PIT histogram") 
pithist(m_odisp, main = "PIT histogram")
pithist(m_udisp, main = "PIT histogram")
pithist(m_norm, main = "Customized PIT histogram",
  breaks = c(0, 0.005, seq(0,1,length.out = 22)[-c(1,22)], 0.995, 1)) 
pithist(m_rskew, main = "Customized PIT histogram",
  breaks = c(0, 0.005, seq(0,1,length.out = 22)[-c(1,22)], 0.995, 1)) 
pithist(m_lskew, main = "Customized PIT histogram",
  breaks = c(0, 0.005, seq(0,1,length.out = 22)[-c(1,22)], 0.995, 1)) 
pithist(m_htail, main = "Customized PIT histogram", 
  breaks = c(0, 0.005, seq(0,1,length.out = 22)[-c(1,22)], 0.995, 1)) 
pithist(m_ltail, main = "Customized PIT histogram", 
  breaks = c(0, 0.005, seq(0,1,length.out = 22)[-c(1,22)], 0.995, 1))
pithist(m_odisp, main = "Customized PIT histogram",
  breaks = c(0, 0.005, seq(0,1,length.out = 22)[-c(1,22)], 0.995, 1)) 
pithist(m_udisp, main = "Customized PIT histogram",
  breaks = c(0, 0.005, seq(0,1,length.out = 22)[-c(1,22)], 0.995, 1)) 
rootogram(m_norm, main = "Rootogram")
rootogram(m_rskew, main = "Rootogram")
rootogram(m_lskew, main = "Rootogram")
rootogram(m_htail, main = "Rootogram")
rootogram(m_ltail, main = "Rootogram")
rootogram(m_odisp, main = "Rootogram")
rootogram(m_udisp, main = "Rootogram")
par(mfrow = c(1, 1))
dev.off()
```

![](figures/graph_eval_meth_qq.svg){width=100%}

Predictive distribution | well calibrated | too skew to the left | too skew to the right | tails too light | tails too heavy | underdispersed (underestimated variance) | overdispersed (overestimated variance)
--- | --- | --- | --- | --- | --- | --- | ---
**Resdiuals** | normal | right skewed | left skewed | heavy tailed | light tailed | overdispersed | underdispersed
**Q-Q plot** | bisecting line | positive curvature (bends above the line at both ends) | negative curvature (bends down at both ends) | reverse S-shape (dips below the line at the low end and rises above it at the high end) | S-shape | crossing qqline from below (?) | crossing qqline from above ?
**Worm plot** | horizontal line | U-shape | inverse U-shape | S-shape on the left bent down | S-shape on the left bent up | positive slope | negative slope
**PIT histogram** | uniform | skewed | skewed | superimposed U-shape | superimposed inverse U-shape" | U-shape | inverse U-shape 
**Rootogram** | no deviations | ? | ? | wave-like (underfitting in the tails and the center) | ? | ? | ?
**Interpretation** | no misspecifications | ? | ? |  values more extrem as expected |  values less extrem as expected | ? | ?

## References

