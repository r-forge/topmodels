---
title: "Graphical Evaluation: Real Cases"
author: "Moritz Lang, Achim Zeileis"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
bibliography: ref.bib
vignette: >
  %\VignetteIndexEntry{Graphical Evaluation: Simulations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteDepends{topmodels,crch,ggplot2,MASS,rmutil,sn}
  %\VignetteKeywords{FIXME}
  %\VignettePackage{topmodels}
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{r preliminaries, echo = FALSE, message = FALSE}
library("topmodels")
library("crch")
library("ggplot2")
options(digits = 4)
knitr::opts_chunk$set(fig.aling = "center")

make_residuals_plot <- function(object, breaks = breaks) {

  name <- deparse(substitute(object))

  set.seed(1)
  pithist(object, breaks = c(0, 0.01, 1:9 / 10, 0.99, 1), main = name)

  set.seed(1)
  hist(qq <- qresiduals(object), freq = FALSE,
    main = sprintf("Histogram of qresiduals(%s)", name), xlab = "Q-Q residuals")
  curve(dnorm, from = min(qq), to = max(qq), col = 2, add = TRUE)
  legend("topright", "std. norm", lty = 1, col = 2, bty = "n")

  set.seed(1)
  boxplot(data.frame("Q-Q residuals" = qresiduals(object), "std. norm" = rnorm(length(qresiduals(object)))))
}

make_topmodels_plot <- function(object) {
  topmodels(object, which = c(1:2, 4:5), ask = FALSE, spar = FALSE)
}
```

## Precipitation forecasts

Censored or truncated response variables occur in a variety of applications.
Censored data arise if exact values are only reported in a restricted range.
Data may fall outside this range but are reported at the range limits. In
contrast, if data outside this range are omitted completely we call the dataset
truncated. E.g., consider wind measurements with an instrument that needs a
certain minimum wind speed to start working. If wind speeds below this minimum
are recorded as ≤ minimum the data are censored. If only wind speeds exceeding
this limit are reported and those below are omitted the data are truncated.
Even if the generating process is not as clear, censoring or truncation can be
useful to consider limited data such as precipitation observations [@Messner+Mayr+Zeileis:2016]. 

The following application shows numerical weather predictions for daily precipitation sums
for Innsbruck (Austria).

```{r crch data}
data("RainIbk", package = "crch")

RainIbk <- sqrt(RainIbk)
RainIbk$ensmean <- apply(RainIbk[,grep('^rainfc',names(RainIbk))], 1, mean)
RainIbk$enssd <- apply(RainIbk[,grep('^rainfc',names(RainIbk))], 1, sd)
RainIbk <- subset(RainIbk, enssd > 0)
```

```{r crch models}
## linear model
LM <- lm(rain ~ ensmean, data = RainIbk)

## heteroscedastic censored regression with a gaussian distribution assumption
CRCH_gaus <- crch(rain ~ ensmean | log(enssd), data = RainIbk, left = 0,
  dist = "gaussian")

## heteroscedastic censored regression with a logistic distribution assumption
CRCH_log <- crch(rain ~ ensmean | log(enssd), data = RainIbk, left = 0,
  dist = "logistic")
```

```{r crch overview-plot, echo = FALSE, eval = FALSE, fig.height = 6, out.width = "100%", fig.align = "center"}
par(mfrow = c(1, 1), bg = "#f7f7f7")

plot(rain~ensmean, data = RainIbk, pch = 19, col = gray(0, alpha = 0.2))
abline(coef(LM)[1:2], col = 1, lwd = 2)
abline(coef(CRCH_gaus)[1:2], col = 2, lwd = 2)
abline(coef(CRCH_log)[1:2], col = 4, lwd = 2)

legend("topright", lwd = c(1, 1, 1), lty = c(1, 1, 1), col = c(1, 2, 4), 
  c("LM", "CRCH gaussian", "CRCH logistic"), bty = "n")

par(mfrow = c(1, 1))
```

```{r crch simulated, echo = FALSE, eval = FALSE}
set.seed(1)
d <- data.frame(x = runif(500, -1, 1), err = rnorm(500, sd = 1)) |>
  transform(y = x + err) |>
  transform(yc = pmax(0, y))
m0 <- lm(y ~ x, data = d)
m1 <- crch(y ~ x | x, data = d)
m2 <- crch(yc ~ x | x, data = d, left = 0)
m3 <- trch(y ~ x | x, data = d, left = 0, subset = y > 0)

cbind(coef(m1), coef(m2), coef(m3))
summary(m1)
summary(m2)
summary(m3)

library("modelsummary")
modelsummary(list(full = m1, censored = m2, truncated = m3))

plot(c(
  wormplot(m1, plot = FALSE), 
  wormplot(m2, plot = FALSE), 
  wormplot(m3, plot = FALSE)
))
```

```{r topmodels-rootogram, echo = FALSE, fig.height = 2.5, out.width = "100%", fig.align = "center"}
r1 <- rootogram(LM, plot = FALSE)
r2 <- rootogram(CRCH_gaus, plot = FALSE)

gg1 <- autoplot(
    c(r1, r2)
  ) 
gg1
```

```{r topmodels-pithist, echo = FALSE, fig.height = 2.5, out.width = "100%", fig.align = "center"}
p1 <- pithist(LM, plot = FALSE)
p2 <- pithist(CRCH_gaus, plot = FALSE)
p3 <- pithist(CRCH_log, plot = FALSE)

gg2 <- autoplot(
    c(p1, p2, p3), 
    style = "line", 
    col = c(1, 2, 4), 
    confint = FALSE,
    ylim = c(0.6, 1.4), 
    single_graph = TRUE
  ) + 
  geom_pithist_confint(
    aes(x = mids, y = counts, width = width, group = group), 
    style = "line", 
    colour = 1
  ) + 
  geom_pithist_ref(
    aes(x = mids, y = counts, width = width, group = group), 
    style = "line", 
    colour = 1,
    linetype = 2,
    size = 0.5
  )
gg2
```

```{r topmodels-wormplot, echo = FALSE, fig.height = 2.5, out.width = "100%", fig.align = "center"}
w1 <- wormplot(LM, plot = FALSE)
w2 <- wormplot(CRCH_gaus, plot = FALSE)
w3 <- wormplot(CRCH_log, plot = FALSE)

gg3 <- autoplot(
    c(w1, w2, w3), 
    style = "line", 
    col = c(1, 2, 4), 
    confint = FALSE,
    range = TRUE,
    single_graph = TRUE
  ) 
gg3
```


## References


